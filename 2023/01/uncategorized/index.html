<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CAM详解 | Pixel的三味书屋</title><meta name="author" content="PixelChen,PixelChen24@outlook.com"><meta name="copyright" content="PixelChen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言 众所周知，深度学习是一个&quot;黑盒&quot;系统。它通过“end-to-end”的方式来工作，输入数据例如RGB图像，输出目标例如类别标签、回归值等，中间过程不可得知。如何才能打开“黑盒”，一探究竟，让“黑盒”变成“灰盒”，甚至“白盒”？因此就有了“深度学习可解释性“这一领域，而CAM(Class Activation Mapping)技术就是其中之一，其利用特征可视化来探究深度卷积">
<meta property="og:type" content="article">
<meta property="og:title" content="CAM详解">
<meta property="og:url" content="http://pixelchen.top/2023/01/uncategorized/index.html">
<meta property="og:site_name" content="Pixel的三味书屋">
<meta property="og:description" content="前言 众所周知，深度学习是一个&quot;黑盒&quot;系统。它通过“end-to-end”的方式来工作，输入数据例如RGB图像，输出目标例如类别标签、回归值等，中间过程不可得知。如何才能打开“黑盒”，一探究竟，让“黑盒”变成“灰盒”，甚至“白盒”？因此就有了“深度学习可解释性“这一领域，而CAM(Class Activation Mapping)技术就是其中之一，其利用特征可视化来探究深度卷积">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://markdown-bed-pixel.oss-cn-shanghai.aliyuncs.com/typora/pexels-pixabay-533923.webp">
<meta property="article:published_time" content="2023-01-08T12:17:38.000Z">
<meta property="article:modified_time" content="2023-01-16T12:39:39.161Z">
<meta property="article:author" content="PixelChen">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://markdown-bed-pixel.oss-cn-shanghai.aliyuncs.com/typora/pexels-pixabay-533923.webp"><link rel="shortcut icon" href="/img/coffee.png"><link rel="canonical" href="http://pixelchen.top/2023/01/uncategorized/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CAM详解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-01-16 20:39:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://markdown-bed-pixel.oss-cn-shanghai.aliyuncs.com/typora/v2-21a74c3e5d5b17a13c9a2d959a4b810e_720w.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-house"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-timeline"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 电影</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://markdown-bed-pixel.oss-cn-shanghai.aliyuncs.com/typora/pexels-pixabay-533923.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Pixel的三味书屋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-house"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-timeline"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 电影</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CAM详解<a class="post-edit-link" href="https://github.com/PixelChen24/PixelChen24.github.io/edit/main/source/_posts/2023/01/CAM详解.md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-08T12:17:38.000Z" title="发表于 2023-01-08 20:17:38">2023-01-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-01-16T12:39:39.161Z" title="更新于 2023-01-16 20:39:39">2023-01-16</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CAM详解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2023/01/uncategorized/index.html#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>前言<br>
众所周知，深度学习是一个&quot;黑盒&quot;系统。它通过“end-to-end”的方式来工作，输入数据例如RGB图像，输出目标例如类别标签、回归值等，中间过程不可得知。如何才能打开“黑盒”，一探究竟，让“黑盒”变成“灰盒”，甚至“白盒”？因此就有了“深度学习可解释性“这一领域，而CAM(Class Activation Mapping)技术就是其中之一，其利用特征可视化来探究深度卷积神经网络的工作机制和判断依据。本文通过七篇论文来论述该技术，并附带代码解析。</p>
<p>CAM是什么？<br>
CAM全称Class Activation Mapping，既类别激活映射图，也被称为类别热力图、显著性图等。是一张和原始图片等同大小图，该图片上每个位置的像素取值范围从0到1，一般用0到255的灰度图表示。可以理解为对预测输出的贡献分布，分数越高的地方表示原始图片对应区域对网络的响应越高、贡献越大。</p>
<p>为了更直观表达，一般将灰度图转化为彩色图。例如可以使用Opencv 函数转换：</p>
<p>img_color = cv2.applyColorMap(img_gray, cv2.COLORMAP_JET) # 将灰度图转化为伪色彩图，</p>
<h1>COLORMAP_JET 为输出的颜色模式</h1>
<p>可视化的时候，可以利用热力图和原图叠加的形式呈现。如下图，颜色越深红的地方表示值越大。可以认为，网络预测“狗”这个类别时，红色高亮区域是其主要判断依据。</p>
<p>A.原始图片 B. CAM灰度图 C. CAM彩色热图 D. 原图+CAM热图叠加</p>
<p>CAM有什么用？<br>
CAM主要有以下作用:</p>
<p>有助于理解和分析神经网络的工作原理及决策过程，进而去更好地选择或设计网络。例如对于分类网络，如果参考CAM相当于除了分类accuracy以外，对网络又提出了更高的要求：不但要求预测准确率高，还需要网络提取到我们需要的特征。下图可以看出，不同网络对相同的数据的CAM是有较为明显的差异。当然即便是同一个网络，不同训练过程也会导致CAM有很大的差异。</p>
<p>A.原始图片 B. Resnet50 预测结果 C. Resnet34 预测结果</p>
<p>利用可视化的信息引导网络更好的学习，例如可以利用CAM信息通过&quot;擦除&quot;或&quot;“裁剪”&quot;的方式对数据进行增强；<br>
利用CAM作为原始的种子，进行弱监督语义分割或弱监督定位。既然CAM能够cover到目标物体，所以可以仅利用分类标注来完成语义分割或目标检测任务，极大程度上降低了标注的工作量，但这对CAM的要求更高。一般情况下，分类网络只会提取到最具有判别性的特征。所以也有很多做法来提高分类网络的CAM精准度，如下图。</p>
<p>插图来自: <em>Tell Me Where to Look: Guided Attention Inference Network</em><br>
如何获取CAM？</p>
<p>卷积神经网络的卷积操作可以看做是滤波器对图片进行特征提取，通过滑动窗口的方式实现，因此特征层和输入图片存在空间上的对应关系。如上图表示某层特征图，  表示特征图第  层  行  列的值，可以认为是被层层卷积核过滤后而保留的有效信息，其值越大，表明特征越有效，对网络预测结果越重要。一个深层的卷积神经网络，通过层层卷积操作，提取空间和语义信息。一般存在其他更难理解的层，例如分类的全连接层、softmax层等，很难以利用可视化的方式展示出来。所以，CAM的提取一般发生在卷积层，尤其是最后一层卷积。通常每一层的特征图还会有很多层，一般称为channel（通道），例如Resnet18最后一层特征图有512个通道。这512个通道可以认为提取到不同的特征，该特征具有高度抽象性，且每个通道对最后的结果贡献不同，因此单独可视化每个通道获取热图也让人很难理解。所以一般CAM的获取是根据每个通道不同的贡献大小去融合获取一张CAM。</p>
<p>所以，总结CAM获取的步骤如下：</p>
<p>step1：提取需要可视化的特征层，例如尺寸为  的张量；</p>
<p>step2：获取该张量的每个channel的权重，即长度为512的向量；</p>
<p>step3：通过线性融合的方式，将该张量在channel维度上加权求和，获取尺寸为7*7的map；</p>
<p>step4：对该map进行归一化，并通过插值的方式resize到原图尺寸；</p>
<p>类似目标检测领域 anchor-base和anchor-free， CAM也有两种不同的阵营gradient-based和gradient-free。 做法不同，其本质类似: 提取目标特征层，并进行加权融合获取激活图(CAM)。 主要的区别在于上述step2叙述的特征层之间融合权重的选择上。gradient-based利用梯度获取权重，gradient-free 则不需要梯度信息。本文根据时间顺序，解析7篇比较重要CAM获取方式的论文，帮助读者对网络处理信息流有更深入的理解。 “Talk is cheap. Show me the code”。本文也会给出核心代码实现的解释。参考代码连接: <a target="_blank" rel="noopener" href="https://pypi.org/project/torch-cam/">https://pypi.org/project/torch-cam/</a></p>
<p>本文涉及的论文如下:</p>
<p>gradient-based:</p>
<p>Grad-CAM (2016.10)<br>
Grad-CAM++ (2017.10)<br>
Smooth Grad-CAM++ (2019.08)<br>
gradient-free:</p>
<p>CAM (2015.12)<br>
score-CAM (2019.10)<br>
ss-CAM (2020.06)<br>
Ablation-CAM (2020)<br>
开山之作：利用GAP获取CAM<br>
论文标题: Learning Deep Features for Discriminative Localizatiion</p>
<p>论文地址: <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1512.04150.pdf">https://arxiv.org/pdf/1512.04150.pdf</a></p>
<p>首先介绍一下GAP(Global average pooling，全局平均池化 )操作。参考上图， 这个概念来自network in network，利用全局平均池化获取特征向量，再和输出层进行全连接。GAP直接将特征层尺寸  转化成  ，既每一层的特征图里面的所有像素点值求平均获取对应特征向量值作为GAP输出。</p>
<p>GAP的好处是：</p>
<p>可以减少参数的数量，可以看出， 不管  多大，都直接转化为了1个值，池化非常彻底。另外GAP层是没有数据参数的。因为参数量少了，GAP也降低了过拟合的风险。<br>
一般情况下，可适应任意尺寸的图片输出。因为不管输入尺寸多大，通过GAP都转化为了长度和最后一层特征图channel等长的特征向量，对于一个设计好的网络，该值为固定值。所以在部署测试的时候，网络可以处理不同尺寸的图片，而不需要resize。<br>
GAP直接对特征层的空间信息进行求和，整合了整个空间的信息，所以网络对输入的空间变化的鲁棒性更强。</p>
<p>本文的做法通过上图就可以很直观理解，  到  为GAP到输出层全连接到目标类别（上图目标类别为狗）的权重，由于GAP特征向量是直接来自于特征图(线性关系)，因此该权重可视为特征图对目标类别score的贡献程度，进行加权求和既可以获取CAM，公式如下:</p>
<p>其中  为最后一层特征图位置  的值，  为类别c的全连接权重。</p>
<p>该方法的缺点是只能适用于最后一层特征图和全连接之间是GAP操作。 如果不是，就需要用户修改网络并重新训练(或 fine-tune)。所以对本文简单概括即为：修改网络全连接为GAP形式，利用GAP层与全连接的权重作为特征融合权重，对特征图进行线性融合获取CAM。</p>
<p>核心代码解读:</p>
<p>代码非常简单， 提取到特征图和目标类别全连接的权重，直接加权求和，再经过relu操作去除负值，最后归一化获取CAM，具体如下:</p>
<h1>获取全连接层的权重</h1>
<p>self._fc_weights = self.model._modules.get(fc_layer).weight.data</p>
<h1>获取目标类别的权重作为特征权重</h1>
<p>weights=self._fc_weights[class_idx, :]</p>
<h1>这里self.hook_a为最后一层特征图的输出</h1>
<p>batch_cams = (weights.unsqueeze(-1).unsqueeze(-1) * self.hook_a.squeeze(0)).sum(dim=0)</p>
<h1>relu操作,去除负值</h1>
<p>batch_cams = F.relu(batch_cams, inplace=True)</p>
<h1>归一化操作</h1>
<p>batch_cams = self._normalize(batch_cams)<br>
更通用的做法：Grad-CAM<br>
论文标题: Grad-CAM: Visual Explanations from Deep Networks via Gradient-based Localization</p>
<p>论文地址: <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1610.02391.pdf">https://arxiv.org/pdf/1610.02391.pdf</a></p>
<p>上文的局限性就是网络架构里必须有GAP层，但并不是所有模型都配GAP层的。而本文就是为克服该缺陷提出的，其基本思路是目标特征图的融合权重  可以表达为梯度。另外，因为热图关心的是对分类有正面影响的特征，所以加上了relu以移除负值。其实并不一定要是分类问题，只要是可求导的激活函数，在其他问题也一样使用Grad-CAM。特征融合权重计算公式如下:</p>
<p>其中  为目标类别的score，后面会论述该score具体是什么。  为需要可视化的目标特征图。论文里证明了grad-CAM是上文利用GAP一般形式，这里不再复述，具体可看论文附录。这里提出两个问题并进行论述。</p>
<p>A. grad-CAM和 CAM（这里指上一篇论文的做法）的区别？</p>
<p>CAM 只能用于最后一层特征图和输出之间是GAP的操作，grad-CAM可适用非GAP连接的网络结构；<br>
CAM只能提取最后一层特征图的热力图，而gard-CAM可以提取任意一层；<br>
B. 目标类别score  是用通过softmax之后的还是之前的？</p>
<p>论文原文中目标类别score是指网络未经过softmax的得分，但是某些代码实现当中也使用了通过softmax后的。二者有无区别？下面我们通过公式推导一下。因为这两种做法仅仅相差一个softmax，所以对softmax的求导。假设softmax层有C个输出，记为：  。则softmax输出为：</p>
<p>则输出  对  的偏导为，由于这里计算的是目标类别，所以仅需计算对应输出的偏导：</p>
<p>所以特征融合的权重则变成：</p>
<p>可以看出，二者的梯度差异就是softmax输出的多一项  ，而对于已经训练好的网络，该项为定值。后面特征层进行加权求和，再归一化后，该项  会被消掉。所以通过softmax和不通过softmax在理论上完全一致。但是在实际应用中我发现，加上softmax后，权重  会变得非常小，就是因为训练的充分好的网络，预测输出  的值是非常接近1的，所以  的值非常非常小，存在丢失精度的风险。所以目标类别score建议使用不经过softmax的值。</p>
<p>核心代码解读:</p>
<p>仅需要对目标类别的score进行求导， 然后追踪到目标特征图的梯度， 对该梯队进行element-wise求平均(GAP操作)即获得特征融合的权重。具体如下:</p>
<h1>利用onehot的形式锁定目标类别</h1>
<p>one_hot = np.zeros((1, output.size()[-1]), dtype=np.float32)<br>
one_hot[0][index] = 1<br>
one_hot = torch.from_numpy(one_hot).requires_grad_(True)</p>
<h1>获取目标类别的输出,该值带有梯度链接关系,可进行求导操作</h1>
<p>one_hot = torch.sum(one_hot * output)<br>
self.model.zero_grad()<br>
one_hot.backward(retain_graph=True) # backward 求导</p>
<h1>获取对应特征层的梯度map</h1>
<p>grads_val = self.extractor.get_gradients()[-1].cpu().data.numpy()<br>
target = features[-1].cpu().data.numpy()[0, :] # 获取目标特征输出<br>
weights = np.mean(grads_val, axis=(2, 3))[0, :] # 利用GAP操作, 获取特征权重<br>
cam = weights.dot(target.reshape((nc, h * w)))</p>
<h1>relu操作,去除负值, 并缩放到原图尺寸</h1>
<p>cam = np.maximum(cam, 0)<br>
cam = cv2.resize(cam, input.shape[2:])</p>
<h1>归一化操作</h1>
<p>batch_cams = self._normalize(batch_cams)<br>
比Grad-CAM更进一步：Grad-CAM++<br>
论文标题: Grad-CAM++: Improved Visual Explanations for Deep Convolutional Networks</p>
<p>论文地址: <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1710.11063.pdf">https://arxiv.org/pdf/1710.11063.pdf</a></p>
<p>本文的提出是为了优化Grad-CAM的结果，定位会更精准，也更适用于目标类别物体在图像中不止一个的情况。 Grad-CAM是利用目标特征图的梯度求平均(GAP)获取特征图权重，可以看做梯度map上每一个元素的贡献是一样。 而本文认为梯度map上的每一个元素的贡献不同，因此增加了一个额外的权重对梯度map上的元素进行加权。其中该权重  如下：</p>
<p>其中c为目标类别， k表示特征图第 k层(或者说第 k个channel)，  为该层特征图上的元素位置。可以看出公式中用到了二阶偏导和三阶偏导，计算会更复杂。本文不做详细推导，具体可见论文。</p>
<p>核心代码解读:</p>
<p>这里值得说明的是， 上面的公式有二次偏导和三次偏导，论文中进行了幂次方的转化，实现更容易。</p>
<h2 id="获取特征权重的过程">获取特征权重的过程</h2>
<h1>反向传播</h1>
<p>self._backprop(scores, class_idx)</p>
<h1>注意,这里用乘法,因为论文中将2次偏导和3次偏导进行了2次方和3次方的转化</h1>
<p>grad_2 = self.hook_g.pow(2)<br>
grad_3 = self.hook_g.pow(3)</p>
<h1>获取alpha权重map</h1>
<p>alpha = grad_2 / (2 * grad_2 + (grad_3 * self.hook_a).sum(axis=(2, 3), keepdims=True))</p>
<h1>利用alpha 权重map去获取特征权重</h1>
<p>return alpha.squeeze_(0).mul_(torch.relu(self.hook_g.squeeze(0))).sum(axis=(1, 2))<br>
结合梯度平滑策略： Smooth Grad-CAM++<br>
论文标题: Smooth Grad-CAM++: An Enhanced Inference Level Visualization Technique for Deep Convolutional Neural Network Models</p>
<p>论文地址: <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1908.01224.pdf">https://arxiv.org/pdf/1908.01224.pdf</a></p>
<p>该论文做法是结合smoothGrad来优化CAM效果，首先解释一下smoothGrad。对于分类网络，最终分类类别取决于哪个类别的score最大，公式为：</p>
<p>其中x为输入图片，  为类别c的类别score。</p>
<p>对x求导，获取：</p>
<p>表示x的每个像素的微小变化会对c类的分类score产生多大的影响，称之为saliency maps，如下图。</p>
<p>该方法虽然能显示出与分类结果相关的区域，但如图所示，存在很多噪声，且很难探究噪声的组成。smoothGrad的做法也很简单，即为多次输入加入随机噪声的图片，对结果并求平均，用以消除输出saliency maps的&quot;噪声&quot;，达到“引入噪声”来“消除噪声”的效果。核心公式如下:</p>
<p>n为对原图增加噪声并前向的次数，  为高斯噪声。可以看到，随着n的增加，噪声逐渐减少，saliency maps逐渐聚焦到目标物体区域。</p>
<p>回到Smooth Grad-CAM++，如下图所示，和Grad-CAM++的区别在于特征图融合权重的求法上， 对原图多次增加高斯噪声，对目标类别对特征图的梯度求平均。</p>
<p>上图中，对于Grad-CAM++中的  被替换成了  ，其中  表示为添加噪声的原图获取的  ，共进行了n次操作。</p>
<p>核心代码解读:</p>
<p>这里给的实现smoothGrad操作是作用在alpha的2次偏导和3次偏导上， 实现方式不同，本质一样。</p>
<p>for i in range(self.n_samples): # 进行n_samples次加噪声操作<br>
self.model.zero_grad()<br>
# 输入图片增加高斯噪声<br>
x_with_noise = torch.normal(mean=x, std=std_tensor).requires_grad_()<br>
score = self.model(x_with_noise)<br>
score[0, idx].backward(retain_graph=True) # 求梯度<br>
activations = self.values.activations<br>
gradients = self.values.gradients<br>
n, c, _, _ = gradients.shape<br>
# 获取alpha, 和grad-cam++一致<br>
numerator = gradients.pow(2)<br>
denominator = 2 * gradients.pow(2)<br>
ag = activations * gradients.pow(3)<br>
denominator += <br>
ag.view(n, c, -1).sum(-1, keepdim=True).view(n, c, 1, 1)<br>
denominator = torch.where(<br>
denominator != 0.0, denominator, torch.ones_like(denominator))<br>
alpha = numerator / (denominator + 1e-7)<br>
relu_grad = F.relu(score[0, idx].exp() * gradients)<br>
# 获取weights<br>
weights = (alpha * relu_grad).view(n, c, -1).sum(-1).view(n, c, 1, 1)<br>
# 对特征层加权融合, 并进行relu+归一化操作<br>
cam = (weights * activations).sum(1, keepdim=True)<br>
cam = F.relu(cam)<br>
cam -= torch.min(cam)<br>
cam /= torch.max(cam)<br>
total_cams += cam<br>
total_cams /= self.n_samples # 求平均操作<br>
return total_cams.data<br>
gradient-free的做法： score-CAM 和 ss-CAM<br>
论文标题: Score-CAM: Score-Weighted Visual Explanations for Convolutional Neural Networks</p>
<p>论文地址: <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1910.01279.pdf">https://arxiv.org/pdf/1910.01279.pdf</a></p>
<p>本文摒弃了利用梯度获取特征权重的做法，作者认为：</p>
<p>对于深度神经网络，梯度可能是存在噪声的，并存在饱和问题。<br>
利用Grad-CAM很容易找到错误置信度的样本，既具有更高权重的激活图对网络输出的贡献较小的例子。<br>
因此本文提出了gradient-free 的做法。首先，作者定义了CIC( (Increase of Confidence)的概念，既相对于baseline图片的置信度增量，公式如下:</p>
<p>其中X为输入图片， 为baseline图片，可以设置为0，既全黑图片。  为输入类别得分的神经网络，  为第k层特征图， l为神经网络第l层卷积。</p>
<p>本文的做法流程为：</p>
<p>解释一下：对获取的特征图进行channel-wise遍历，对每层特征图进行上采样+归一化，与原始图片进行pixel-wise相乘融合，然后送进网络获取目标类别score（softmax后），减去baseline的目标类别score，获取CIC。再进行softmax操作来保证所有CIC之和为1。最后将CIC作为特征融合权重融合需要可视化的特征层。</p>
<p>核心代码解读:</p>
<p>值得注意的是，计算CIC时默认使用的baseline为全黑的图片，既全0的矩阵，因此CIC score不需要减去baseline的score。</p>
<p>with torch.no_grad():# gradient-free, 所以不需要计算梯度<br>
for i in range(K): # 对K层特征图进行遍历操作<br>
# 获取第i层特征图,并进行上采样操作<br>
saliency_map = torch.unsqueeze(activations[:, i, :, :], 1)<br>
saliency_map = F.interpolate(saliency_map, size=(h, w), mode=‘bilinear’)<br>
# 归一化<br>
norm_saliency_map = (saliency_map - saliency_map.min()) /<br>
(saliency_map.max() - saliency_map.min())<br>
# 利用第i层特征图作为mask覆盖原图,重新送入网络获取对应类别得分<br>
output = self.model_arch(input * norm_saliency_map)<br>
output = F.softmax(output)<br>
score = output[0][predicted_class]<br>
# 利用该得分作为权重对该层的特征图进行加权线性融合, baseline默认为全0的图,所以这里直接<br>
# 用该得分作为特征权重<br>
score_saliency_map +=  score * saliency_map<br>
# relu去除负值<br>
score_saliency_map = F.relu(score_saliency_map)<br>
# 归一化<br>
score_saliency_map = (score_saliency_map - score_saliency_map.min())/<br>
(score_saliency_map_max - score_saliency_map.max())<br>
# score_saliency_map 为所求<br>
return score_saliency_map</p>
<p>论文标题: SS-CAM: Smoothed Score-CAM for Sharper Visual Feature Localization</p>
<p>论文地址: <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2006.14255v1.pdf">https://arxiv.org/pdf/2006.14255v1.pdf</a></p>
<p>本文和score-CAM的关系类似于smooth Grad-CAM++ 和 Grad-CAM++的关系。本文同样是利用了smoothGrad技术来降低输出噪声。关于smoothGrad平滑策略， 本文给出了两种做法，一种是噪声增加在特征图上，一种是噪声增加在输入图上。这两种做法在论文给出的不同数据集上的测试指标也互有高低，具体选择也依情况而定。</p>
<p>利用Ablation分析的方法：Ablation-CAM<br>
论文标题: Ablation-CAM: Visual Explanations for Deep Convolutional Network via Gradient-free Localization</p>
<p>论文地址: <a target="_blank" rel="noopener" href="https://openaccess.thecvf.com/content_WACV_2020/papers/Desai_Ablation-CAM_Visual_Explanations_for_Deep_Convolutional_Network_via_Gradient-free_Localization_WACV_2020_paper.pdf">https://openaccess.thecvf.com/content_WACV_2020/papers/Desai_Ablation-CAM_Visual_Explanations_for_Deep_Convolutional_Network_via_Gradient-free_Localization_WACV_2020_paper.pdf</a></p>
<p>本文利用ablation分析来确定特征图上每个单元的重要程度。Ablation Study 可以理解为通过控制变量地进行移除各种组件等来探究各个因素对于模型整体贡献的强弱多寡，找到对性能最主要的影响因素，这里不对该理论作过多介绍。直接看文章的做法。</p>
<p>k为特征图的channel个数，这里的  是原始图片c类别的类别score输出，  为将特征图第k个channel全部设置为0后，将原始图片再送进网络，获取的c类别的score。二者得分的之差，再除以  就获取slope，其实就是特征融合的权重。</p>
<p>由于计算  是个比较耗时的操作，于是有下面的简化形式:</p>
<p>然后和Grad-CAM一致，对特征图利用该权重进行融合+relu去负值，如下:</p>
<p>一句话概括就是遍历地将每层特征图置0后再进行网络前向获取目标类别得分, 该值与原始得分的相对大小作为特征图融合权重。论文实验表明, 该方法是优于grad-CAM的.</p>
<p>后记<br>
本文针对CAM的两种方式gradient-based和gradient-free进行了梳理，由于水平问题，可能有些地方理解不特别到位。抛砖引玉，希望能让读者对该任务有一个更直观的感受。</p>
<p>码字不易，跪求一赞！</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://pixelchen.top">PixelChen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://pixelchen.top/2023/01/uncategorized/index.html">http://pixelchen.top/2023/01/uncategorized/index.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://pixelchen.top" target="_blank">Pixel的三味书屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://markdown-bed-pixel.oss-cn-shanghai.aliyuncs.com/typora/pexels-pixabay-533923.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/01/%E8%8B%B1%E8%AF%AD/Rumors.html"><img class="prev-cover" src="https://markdown-bed-pixel.oss-cn-shanghai.aliyuncs.com/typora/pexels-pixabay-533923.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">关于谣言</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/%E5%B7%A5%E5%85%B7/GoogleDriveFastToDownload.html"><img class="next-cover" src="https://picx.zhimg.com/v2-a1a7fef89fe2dbcf2e6eed2965b8a7e5_1440w.jpg?source=172ae18b" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">GoogleDrive千兆带宽下载小寄巧</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://markdown-bed-pixel.oss-cn-shanghai.aliyuncs.com/typora/v2-21a74c3e5d5b17a13c9a2d959a4b810e_720w.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">PixelChen</div><div class="author-info__description">什么都懂一点的屑</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/PixelChen24"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/PixelChen24" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://www.zhihu.com/people/chen-wei-44-38-41" target="_blank" title=""><i class="fab fa-zhihu"></i></a><a class="social-icon" href="https://space.bilibili.com/225293954?spm_id_from=333.1073.0.0" target="_blank" title=""><i class="fab fa-bilibili"></i></a><a class="social-icon" href="mailto:PixelChen24@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">COLORMAP_JET 为输出的颜色模式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">获取全连接层的权重</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">获取目标类别的权重作为特征权重</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">这里self.hook_a为最后一层特征图的输出</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">relu操作,去除负值</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">归一化操作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">利用onehot的形式锁定目标类别</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">8.</span> <span class="toc-text">获取目标类别的输出,该值带有梯度链接关系,可进行求导操作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">9.</span> <span class="toc-text">获取对应特征层的梯度map</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">10.</span> <span class="toc-text">relu操作,去除负值, 并缩放到原图尺寸</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">11.</span> <span class="toc-text">归一化操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%89%B9%E5%BE%81%E6%9D%83%E9%87%8D%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">11.1.</span> <span class="toc-text">获取特征权重的过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">12.</span> <span class="toc-text">反向传播</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">13.</span> <span class="toc-text">注意,这里用乘法,因为论文中将2次偏导和3次偏导进行了2次方和3次方的转化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">14.</span> <span class="toc-text">获取alpha权重map</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">15.</span> <span class="toc-text">利用alpha 权重map去获取特征权重</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/01/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E4%BC%A0%E7%BB%9F%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/Proposal%E7%94%9F%E6%88%90/EdgeBoxes.html" title="Proposal生成之Edge Boxes算法"><img src="https://images.pexels.com/photos/2249961/pexels-photo-2249961.jpeg?auto=compress&amp;cs=tinysrgb&amp;w=300" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Proposal生成之Edge Boxes算法"/></a><div class="content"><a class="title" href="/2023/01/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E4%BC%A0%E7%BB%9F%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/Proposal%E7%94%9F%E6%88%90/EdgeBoxes.html" title="Proposal生成之Edge Boxes算法">Proposal生成之Edge Boxes算法</a><time datetime="2023-01-16T06:48:57.000Z" title="发表于 2023-01-16 14:48:57">2023-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/%E5%B7%A5%E5%85%B7/linux/SSHScreen.html" title="ssh使用screen守护进程"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRVxA46xKvX-1Ysxa04HXfbczIEKU8euH0_dg&amp;usqp=CAU" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ssh使用screen守护进程"/></a><div class="content"><a class="title" href="/2023/01/%E5%B7%A5%E5%85%B7/linux/SSHScreen.html" title="ssh使用screen守护进程">ssh使用screen守护进程</a><time datetime="2023-01-13T11:01:11.000Z" title="发表于 2023-01-13 19:01:11">2023-01-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/PaperReading/OWOD/ProposalCLIP.html" title="ProposalCLIP论文阅读"><img src="https://markdown-bed-pixel.oss-cn-shanghai.aliyuncs.com/typora/image-20230116152223478.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ProposalCLIP论文阅读"/></a><div class="content"><a class="title" href="/2023/01/PaperReading/OWOD/ProposalCLIP.html" title="ProposalCLIP论文阅读">ProposalCLIP论文阅读</a><time datetime="2023-01-13T07:10:51.000Z" title="发表于 2023-01-13 15:10:51">2023-01-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/%E5%B7%A5%E5%85%B7/linux/VscodeSSH.html" title="vscodeSSH优化使用体验"><img src="https://yt3.ggpht.com/ytc/AMLnZu-l3II9ME9uGJ4AZVK2kRSw4i7XFNETCgh62BKk=s900-c-k-c0x00ffffff-no-rj" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="vscodeSSH优化使用体验"/></a><div class="content"><a class="title" href="/2023/01/%E5%B7%A5%E5%85%B7/linux/VscodeSSH.html" title="vscodeSSH优化使用体验">vscodeSSH优化使用体验</a><time datetime="2023-01-12T12:54:28.000Z" title="发表于 2023-01-12 20:54:28">2023-01-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/%E5%B7%A5%E5%85%B7/GoogleDriveFastToDownload.html" title="GoogleDrive千兆带宽下载小寄巧"><img src="https://picx.zhimg.com/v2-a1a7fef89fe2dbcf2e6eed2965b8a7e5_1440w.jpg?source=172ae18b" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GoogleDrive千兆带宽下载小寄巧"/></a><div class="content"><a class="title" href="/2023/01/%E5%B7%A5%E5%85%B7/GoogleDriveFastToDownload.html" title="GoogleDrive千兆带宽下载小寄巧">GoogleDrive千兆带宽下载小寄巧</a><time datetime="2023-01-09T04:40:16.000Z" title="发表于 2023-01-09 12:40:16">2023-01-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By PixelChen</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi,Welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '93ba037ce123079f2cf5',
      clientSecret: '1715759578cd828626d4b4d80e4a5f574b33bbdb',
      repo: 'PixelChen24.github.io',
      owner: 'PixelChen24',
      admin: ['PixelChen24'],
      id: '5a6c7d61de1444557b2b274484da41d9',
      updateCountCallback: commentCount
    },))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>